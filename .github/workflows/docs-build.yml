name: Documentation Build

on:
  pull_request:
    branches: [main]
    paths:
      - 'docs/**'
      - '.readthedocs.yaml'
      - '.github/workflows/docs-build.yml'
  push:
    branches: [main]
    paths:
      - 'docs/**'
      - '.readthedocs.yaml'

jobs:
  build:
    name: Build Documentation
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for sphinx-last-updated-by-git
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-venv
      
      - name: Install documentation dependencies
        working-directory: docs
        run: |
          make install
      
      - name: Build HTML documentation
        working-directory: docs
        run: |
          make html
      
      - name: Upload documentation artifact
        uses: actions/upload-artifact@v4
        with:
          name: documentation-html
          path: docs/_build/
          retention-days: 7
      
      - name: Check for build warnings
        working-directory: docs
        run: |
          if [ -f .sphinx/warnings.txt ] && [ -s .sphinx/warnings.txt ]; then
            echo "::warning::Documentation build produced warnings:"
            cat .sphinx/warnings.txt
          fi
      
      - name: Verify required files
        working-directory: docs/_build
        run: |
          # Check that index.html exists
          if [ ! -f index.html ]; then
            echo "::error::Missing index.html in build output"
            exit 1
          fi
          
          # Check that all sections exist
          for section in tutorial how-to reference explanation; do
            if [ ! -d "$section" ]; then
              echo "::error::Missing $section directory in build output"
              exit 1
            fi
          done
          
          echo "✅ All required documentation files present"
  
  build-pdf:
    name: Build PDF Documentation
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3-venv \
            latexmk \
            fonts-freefont-otf \
            texlive-latex-recommended \
            texlive-latex-extra \
            texlive-fonts-recommended \
            texlive-font-utils \
            texlive-xetex \
            xindy \
            tex-gyre \
            dvipng
      
      - name: Install documentation dependencies
        working-directory: docs
        run: |
          make install
      
      - name: Build PDF documentation
        working-directory: docs
        run: |
          make pdf || echo "::warning::PDF build failed - this is non-critical"
      
      - name: Upload PDF artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: documentation-pdf
          path: docs/_build/*.pdf
          retention-days: 7
          if-no-files-found: warn
  
  test-rtd-config:
    name: Test RTD Configuration
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate .readthedocs.yaml
        run: |
          # Check that .readthedocs.yaml exists
          if [ ! -f .readthedocs.yaml ]; then
            echo "::error::Missing .readthedocs.yaml configuration file"
            exit 1
          fi
          
          # Validate YAML syntax
          python3 -c "import yaml; yaml.safe_load(open('.readthedocs.yaml'))"
          
          echo "✅ RTD configuration is valid"
      
      - name: Check documentation requirements
        run: |
          if [ ! -f docs/requirements.txt ]; then
            echo "::error::Missing docs/requirements.txt"
            exit 1
          fi
          
          # Check for required packages
          for pkg in canonical-sphinx sphinx-design myst-parser; do
            if ! grep -q "$pkg" docs/requirements.txt; then
              echo "::warning::Missing $pkg in docs/requirements.txt"
            fi
          done
          
          echo "✅ Documentation requirements file exists"
